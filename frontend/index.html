<!DOCTYPE html>
<html lang="zh-CN">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>AlphaTrader Pro — AI 全球股票交易平台</title>
  <meta name="description" content="由 DeepSeek-R1 驱动的全球股票市场追踪与自动交易平台" />
  <link rel="stylesheet" href="/static/styles.css?v=4" />
  <!-- TradingView Lightweight Charts -->
  <script src="https://unpkg.com/lightweight-charts@4.1.3/dist/lightweight-charts.standalone.production.js"></script>
</head>

<body>
  <!-- ─── Auth Overlay ─── -->
  <div id="authOverlay" class="auth-overlay" style="display:none;">
    <div class="auth-card">
      <div class="auth-header">
        <div>AlphaTrader Pro</div>
        <p id="authSubtitle" style="font-size:13px;color:var(--text-secondary);">请登录您的交易账户</p>
      </div>

      <div id="loginForm">
        <div class="input-group" style="margin-bottom:16px;">
          <label class="input-label">用户名</label>
          <input class="input" id="loginUsername" placeholder="您的用户名" />
        </div>
        <div class="input-group" style="margin-bottom:20px;">
          <label class="input-label">密码</label>
          <input class="input" id="loginPassword" type="password" placeholder="请输入密码" />
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;" onclick="handleLogin()">
          立即登录
        </button>
        <div class="auth-footer" style="margin-top:20px;">
          没有账户？ <span class="auth-link" onclick="toggleAuthMode('register')">点击注册</span>
        </div>
      </div>

      <div id="registerForm" style="display:none;">
        <div class="input-group" style="margin-bottom:16px;">
          <label class="input-label">用户名</label>
          <input class="input" id="regUsername" placeholder="设置用户名" />
        </div>
        <div class="input-group" style="margin-bottom:16px;">
          <label class="input-label">电子邮箱</label>
          <input class="input" id="regEmail" type="email" placeholder="optional@example.com" />
        </div>
        <div class="input-group" style="margin-bottom:20px;">
          <label class="input-label">密码</label>
          <input class="input" id="regPassword" type="password" placeholder="设置 6 位以上密码" />
        </div>
        <button class="btn btn-primary" style="width:100%;justify-content:center;padding:12px;"
          onclick="handleRegister()">
          免费注册
        </button>
        <div class="auth-footer" style="margin-top:20px;">
          已有账户？ <span class="auth-link" onclick="toggleAuthMode('login')">返回登录</span>
        </div>
      </div>
    </div>
  </div>

  <div class="app-layout">

    <!-- ─── Header ─── -->
    <header class="header">
      <div class="header-logo">
        <div class="logo-icon">📈</div>
        <span class="logo-text">AlphaTrader Pro</span>
      </div>

      <!-- Live Ticker -->
      <div class="header-ticker">
        <div class="ticker-track" id="tickerTrack">
          <!-- Populated by JS -->
        </div>
      </div>

      <div style="display:flex;align-items:center;gap:12px;flex-shrink:0;">
        <div class="ai-badge">⚡ DeepSeek-R1</div>
        <div class="header-status">
          <div class="status-dot" id="statusDot"></div>
          <span id="statusLabel">连接中...</span>
        </div>
        <div style="font-size:11px;color:var(--text-muted);font-family:'JetBrains Mono',monospace;" id="headerTime">
          --:--:--</div>
      </div>
    </header>

    <!-- ─── Sidebar ─── -->
    <nav class="sidebar">
      <!-- User Profile -->
      <div class="user-profile">
        <div class="user-avatar" id="userInitial">U</div>
        <div class="user-info">
          <div class="user-name" id="userNameDisplay">加载中...</div>
          <div style="font-size:10px;color:var(--text-muted);" id="userRole">标准账户</div>
        </div>
      </div>

      <div class="nav-section-label">行情</div>
      <a class="nav-item active" id="nav-markets" onclick="showPage('markets')">
        <span class="nav-icon">🌍</span> 全球市场
      </a>
      <a class="nav-item" id="nav-watchlist" onclick="showPage('watchlist')">
        <span class="nav-icon">⭐</span> 自选股
      </a>

      <div class="nav-section-label">交易</div>
      <a class="nav-item" id="nav-portfolio" onclick="showPage('portfolio')">
        <span class="nav-icon">💼</span> 投资组合
      </a>
      <a class="nav-item" id="nav-trades" onclick="showPage('trades')">
        <span class="nav-icon">📋</span> 交易记录
      </a>

      <div class="nav-section-label">AI 分析</div>
      <a class="nav-item" id="nav-signals" onclick="showPage('signals')">
        <span class="nav-icon">🤖</span> AI 信号
      </a>
      <a class="nav-item" id="nav-chat" onclick="showPage('chat')">
        <span class="nav-icon">💬</span> AI 助手
      </a>

      <div class="nav-section-label">系统</div>
      <a class="nav-item" id="nav-settings" onclick="showPage('settings')">
        <span class="nav-icon">⚙️</span> 设置
      </a>

      <div class="sidebar-footer">
        <div id="sidebarModeLabel" style="margin-bottom:6px;">交易模式加载中...</div>
        <div id="sidebarEquity" style="font-size:14px;font-weight:700;color:var(--accent-bright);">$0.00</div>
        <div id="sidebarPnl" style="font-size:11px;margin-top:2px;" class="text-muted">总收益 $0.00 (0.00%)</div>

        <button class="btn btn-success btn-sm" style="width:100%;margin-top:10px;justify-content:center;"
          onclick="openModal('rechargeModal')">
          💰 立即充值
        </button>

        <div class="logout-btn" onclick="handleLogout()">
          <span>🚪 退出登录</span>
        </div>
      </div>
    </nav>

    <!-- ─── MARKETS PAGE ─── -->
    <main class="main-content active" id="page-markets">
      <div class="page-header">
        <div>
          <div class="page-title">🌍 全球市场</div>
          <div class="page-subtitle">实时追踪全球主要股票指数</div>
        </div>
        <button class="btn btn-primary" onclick="refreshMarkets()">
          <span id="refreshIcon">🔄</span> 刷新数据
        </button>
      </div>

      <!-- Summary Stats -->
      <div class="grid-4 mb-20" id="marketStats">
        <div class="stat-card">
          <div class="stat-label">总资产</div>
          <div class="stat-value" id="totalEquity">$100,000</div>
          <div class="stat-sub" id="equityProviderLabel">加载中...</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总收益</div>
          <div class="stat-value" id="totalReturn">$0.00</div>
          <div class="stat-sub" id="totalReturnPct">+0.00%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">持仓市值</div>
          <div class="stat-value" id="marketValue">$0.00</div>
          <div class="stat-sub" id="unrealizedPnl">未实现盈亏 $0</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">可用现金</div>
          <div class="stat-value" id="cashBalance">$100,000</div>
          <div class="stat-sub" id="cashProviderLabel">📊 加载中...</div>
        </div>
      </div>

      <!-- Region Tabs -->
      <div class="tabs">
        <button class="tab active" onclick="showRegion('Americas')">🇺🇸 美洲</button>
        <button class="tab" onclick="showRegion('Europe')">🇪🇺 欧洲</button>
        <button class="tab" onclick="showRegion('Asia Pacific')">🌏 亚太</button>
      </div>

      <div id="indicesGrid" class="grid-auto mb-20">
        <div class="loading">
          <div class="spinner"></div> 加载市场数据...
        </div>
      </div>

      <!-- Featured Chart -->
      <div class="card">
        <div class="card-title">📊 股票图表
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;">
            <input id="chartSymbolInput" class="input" style="width:120px;padding:5px 10px;font-size:12px;"
              placeholder="股票代码" value="AAPL" />
            <button class="btn btn-ghost btn-sm" onclick="loadChart()">查看</button>
            <select class="input" id="chartPeriod" style="width:90px;padding:5px 8px;font-size:12px;"
              onchange="loadChart()">
              <option value="1mo">1月</option>
              <option value="3mo" selected>3月</option>
              <option value="6mo">6月</option>
              <option value="1y">1年</option>
            </select>
          </div>
        </div>
        <div id="chartMeta" style="display:flex;gap:20px;margin-bottom:12px;flex-wrap:wrap;"></div>
        <div class="chart-container" id="mainChart"></div>
        <div style="display:flex;gap:10px;margin-top:12px;flex-wrap:wrap;">
          <button class="btn btn-gold" onclick="analyzeFromChart()">🤖 DeepSeek-R1 分析</button>
          <button class="btn btn-success btn-sm" onclick="quickBuy()">买入</button>
          <button class="btn btn-danger btn-sm" onclick="quickSell()">卖出</button>
        </div>
      </div>
    </main>

    <!-- ─── WATCHLIST PAGE ─── -->
    <main class="main-content" id="page-watchlist">
      <div class="page-header">
        <div>
          <div class="page-title">⭐ 自选股</div>
          <div class="page-subtitle">您的股票观察列表</div>
        </div>
        <div style="display:flex;gap:8px;">
          <div class="search-wrap">
            <span class="search-icon">🔍</span>
            <input class="input search-input" id="watchlistSearch" placeholder="添加股票代码..." style="width:180px;"
              onkeydown="if(event.key==='Enter')addToWatchlist()" />
          </div>
          <button class="btn btn-primary" onclick="addToWatchlist()">+ 添加</button>
        </div>
      </div>
      <div class="card">
        <div id="watchlistContent">
          <div class="loading">
            <div class="spinner"></div> 加载中...
          </div>
        </div>
      </div>
    </main>

    <!-- ─── PORTFOLIO PAGE ─── -->
    <main class="main-content" id="page-portfolio">
      <div class="page-header">
        <div>
          <div class="page-title">💼 投资组合</div>
          <div class="page-subtitle">持仓概览与绩效分析</div>
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-gold" onclick="analyzePortfolio()">🤖 AI 分析投资组合</button>
          <button class="btn btn-ghost" onclick="if(confirm('确认重置？将清空所有持仓和交易记录'))resetPortfolio()">🔄 重置</button>
        </div>
      </div>

      <!-- Portfolio Stats -->
      <div class="grid-4 mb-20">
        <div class="stat-card">
          <div class="stat-label">总资产</div>
          <div class="stat-value" id="pf-equity">$100,000</div>
          <div class="stat-sub">现金 + 持仓</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">总收益</div>
          <div class="stat-value" id="pf-return">$0.00</div>
          <div class="stat-sub" id="pf-return-pct">+0.00%</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">未实现盈亏</div>
          <div class="stat-value" id="pf-unrealized">$0.00</div>
          <div class="stat-sub">当前持仓浮动</div>
        </div>
        <div class="stat-card">
          <div class="stat-label">交易次数</div>
          <div class="stat-value" id="pf-trades">0</div>
          <div class="stat-sub">总成交次数</div>
        </div>
      </div>

      <!-- Positions Table -->
      <div class="card mb-20">
        <div class="card-title">📊 当前持仓</div>
        <div id="positionsTable">
          <div class="empty-state">
            <div class="empty-icon">📭</div>
            <div>暂无持仓</div>
            <div style="font-size:12px;">在全球市场页面或自选股中买入股票</div>
          </div>
        </div>
      </div>

      <!-- AI Portfolio Analysis -->
      <div class="card mb-20" id="pfAnalysisCard" style="display:none;">
        <div class="card-title">🤖 DeepSeek-R1 投资组合分析</div>
        <div id="pfAnalysisContent"></div>
      </div>

      <!-- Simulation Transfer -->
      <div class="card">
        <div class="card-title">💰 模拟充值与提现</div>
        <div class="page-subtitle">模拟账户资金划转，不涉及真实资金</div>
        <div class="transfer-grid">
          <div class="transfer-card">
            <h4>充值 (Deposit)</h4>
            <div style="display:flex;gap:8px;">
              <input type="number" class="input" id="depositAmount" placeholder="金额" value="10000" />
              <button class="btn btn-success btn-sm" onclick="handleTransfer('DEPOSIT')">充值</button>
            </div>
          </div>
          <div class="transfer-card">
            <h4>提现 (Withdraw)</h4>
            <div style="display:flex;gap:8px;">
              <input type="number" class="input" id="withdrawAmount" placeholder="金额" value="1000" />
              <button class="btn btn-danger btn-sm" onclick="handleTransfer('WITHDRAW')">提现</button>
            </div>
          </div>
        </div>
      </div>
    </main>

    <!-- ─── TRADES PAGE ─── -->
    <main class="main-content" id="page-trades">
      <div class="page-header">
        <div>
          <div class="page-title">📋 交易记录</div>
          <div class="page-subtitle">所有买卖记录</div>
        </div>
        <button class="btn btn-ghost" onclick="loadTrades()">🔄 刷新</button>
      </div>
      <div class="card">
        <div id="tradesTable">
          <div class="loading">
            <div class="spinner"></div> 加载中...
          </div>
        </div>
      </div>
    </main>

    <!-- ─── SIGNALS PAGE ─── -->
    <main class="main-content" id="page-signals">
      <div class="page-header">
        <div>
          <div class="page-title">🤖 AI 交易信号</div>
          <div class="page-subtitle">DeepSeek-R1 生成的买卖建议</div>
        </div>
        <button class="btn btn-primary" onclick="openAnalyzeModal()">+ 分析新股票</button>
      </div>

      <div class="grid-2" style="gap:16px;margin-bottom:16px;">
        <div class="card">
          <div class="card-title">快速分析</div>
          <div style="display:flex;gap:8px;">
            <input class="input" id="analyzeSymbolInput" placeholder="输入股票代码，如 AAPL" style="flex:1;" />
            <button class="btn btn-gold" onclick="analyzeStock()" id="analyzeBtn">
              🤖 分析
            </button>
          </div>
          <div style="margin-top:10px;" id="quickAnalysisResult"></div>
        </div>
        <div class="card">
          <div class="card-title">⚡ 自动交易状态</div>
          <div id="autoTradeStatus" style="font-size:13px;color:var(--text-secondary);"></div>
        </div>
      </div>

      <div class="card">
        <div class="card-title">历史信号记录</div>
        <div id="signalsList">
          <div class="loading">
            <div class="spinner"></div> 加载中...
          </div>
        </div>
      </div>
    </main>

    <!-- ─── CHAT PAGE ─── -->
    <main class="main-content" id="page-chat">
      <div class="page-header">
        <div>
          <div class="page-title">💬 AI 投资助手</div>
          <div class="page-subtitle">与 DeepSeek-R1 实时对话，获取专业投资建议</div>
        </div>
      </div>
      <div class="card">
        <div class="chat-container">
          <div class="chat-messages" id="chatMessages">
            <div class="chat-msg ai">
              👋 您好！我是由 <strong>DeepSeek-R1</strong> 驱动的 AI 投资助手。我可以帮您分析股票、解读市场趋势、评估投资风险。请问您想了解什么？
            </div>
          </div>
          <div class="chat-input-row">
            <input class="chat-input" id="chatInput" placeholder="问我任何关于股市的问题..."
              onkeydown="if(event.key==='Enter'&&!event.shiftKey)sendChat()" />
            <button class="btn btn-primary" onclick="sendChat()" id="chatSendBtn">发送</button>
          </div>
        </div>
        <div style="margin-top:12px;display:flex;gap:8px;flex-wrap:wrap;">
          <button class="btn btn-ghost btn-sm" onclick="quickChat('帮我分析一下当前全球市场的整体趋势')">📊 市场趋势</button>
          <button class="btn btn-ghost btn-sm" onclick="quickChat('现在有哪些股票值得关注？')">⭐ 选股建议</button>
          <button class="btn btn-ghost btn-sm" onclick="quickChat('如何控制投资风险？')">🛡️ 风险管理</button>
          <button class="btn btn-ghost btn-sm" onclick="quickChat('A股和美股的主要区别是什么？')">🌏 市场对比</button>
        </div>
      </div>
    </main>

    <!-- ─── SETTINGS PAGE ─── -->
    <main class="main-content" id="page-settings">
      <div class="page-header">
        <div>
          <div class="page-title">⚙️ 平台设置</div>
          <div class="page-subtitle">配置 API 密钥、交易参数</div>
        </div>
      </div>

      <div class="grid-2" style="gap:20px;align-items:start;">
        <!-- AI Provider Settings -->
        <div class="settings-card">
          <h3><i class="fas fa-robot"></i> AI 引擎配置</h3>
          <div class="settings-group">
            <label>AI 引擎来源</label>
            <select id="aiProviderSelect" class="form-control" onchange="toggleApiKeyVisibility()">
              <option value="deepseek_api">DeepSeek 官方 API (云端)</option>
              <option value="ollama">本地 Ollama (本地免费运行)</option>
            </select>
            <small class="settings-hint">使用本地 GPU 运行开源模型不产生额外费用</small>
          </div>

          <div class="settings-group" id="apiKeyGroup">
            <label>DEEPSEEK API KEY</label>
            <input type="password" id="apiKeyInput" placeholder="sk-..." class="form-control">
            <small class="settings-hint">从 <a href="https://platform.deepseek.com" target="_blank"
                style="color:var(--accent-bright);">platform.deepseek.com</a> 获取 API Key</small>
          </div>

          <button class="btn btn-primary btn-block" onclick="saveAiProvider()"><i class="fas fa-save"></i> 保存 AI
            配置</button>
        </div>

        <!-- Broker Settings (Alpaca) -->
        <div class="settings-card">
          <h3><i class="fas fa-building-columns"></i> 真实券商接入 (Alpaca)</h3>
          <div class="settings-group">
            <label>ALPACA API KEY</label>
            <input type="password" id="alpacaApiKeyInput" placeholder="PK..." class="form-control">
          </div>
          <div class="settings-group">
            <label>ALPACA SECRET KEY</label>
            <input type="password" id="alpacaSecretKeyInput" placeholder="Secret..." class="form-control">
          </div>

          <div class="settings-group">
            <div class="toggle-row">
              <label>Paper Trading (模拟盘)</label>
              <label class="switch">
                <input type="checkbox" id="alpacaPaperModeToggle" checked>
                <span class="slider round"></span>
              </label>
            </div>
            <small class="settings-hint">如果开启，将使用 Alpaca Paper API。如果关闭，将使用真实资金交易！</small>
          </div>

          <button class="btn btn-primary btn-block" onclick="saveAlpacaSettings()"><i class="fas fa-save"></i>
            保存券商配置</button>
        </div>

        <!-- Trading Settings -->
        <div class="card">
          <div class="card-title">⚡ 自动交易设置</div>
          <div style="display:flex;flex-direction:column;gap:18px;">
            <div class="toggle-wrap">
              <label class="toggle">
                <input type="checkbox" id="autoTradeToggle" onchange="saveSettings()" />
                <span class="toggle-slider"></span>
              </label>
              <div>
                <div style="font-size:13px;font-weight:600;">启用自动交易</div>
                <div style="font-size:11px;color:var(--text-muted);">基于 AI 信号自动买卖（模拟）</div>
              </div>
            </div>
            <div class="input-group">
              <label class="input-label">最低置信度阈值</label>
              <input class="input" id="minConfidence" type="number" min="0" max="1" step="0.05" value="0.75"
                onchange="saveSettings()" />
              <div style="font-size:11px;color:var(--text-muted);">AI 信号置信度超过此值才自动交易 (0-1)</div>
            </div>
            <div class="input-group">
              <label class="input-label">单笔风险比例 (%)</label>
              <input class="input" id="riskPct" type="number" min="0.5" max="20" step="0.5" value="2.0"
                onchange="saveSettings()" />
              <div style="font-size:11px;color:var(--text-muted);">每次买入使用可用资金的百分比</div>
            </div>
          </div>
        </div>

        <!-- Account Info -->
        <div class="card">
          <div class="card-title">💰 账户信息</div>
          <div style="display:flex;flex-direction:column;gap:12px;font-size:13px;">
            <div style="display:flex;justify-content:space-between;"><span class="text-secondary">账户类型</span><span
                id="settingsProviderLabel" class="text-gold font-mono">---</span></div>
            <div style="display:flex;justify-content:space-between;"><span class="text-secondary">初始资金</span><span
                class="font-mono">$100,000.00</span></div>
            <div style="display:flex;justify-content:space-between;"><span class="text-secondary">AI 模型</span><span
                style="color:var(--gold-light)">deepseek-reasoner</span></div>
            <div style="display:flex;justify-content:space-between;"><span class="text-secondary">数据源</span><span>Yahoo
                Finance</span></div>
            <button class="btn btn-danger btn-sm" style="margin-top:8px;"
              onclick="if(confirm('确认重置所有交易记录？'))resetPortfolio()">🗑️ 重置交易账户</button>
          </div>
        </div>

        <!-- Data Refresh -->
        <div class="card">
          <div class="card-title">🔄 数据刷新设置</div>
          <div style="display:flex;flex-direction:column;gap:16px;">
            <div class="input-group">
              <label class="input-label">价格刷新间隔 (秒)</label>
              <input class="input" id="refreshInterval" type="number" min="15" max="300" step="15" value="30" />
            </div>
            <button class="btn btn-primary" onclick="saveRefreshInterval()">保存</button>
            <div style="font-size:11px;color:var(--text-muted);">
              ℹ️ 本平台使用 Yahoo Finance 获取延迟行情数据（非实时）。
              若需要实时数据，可接入付费数据服务。
            </div>
          </div>
        </div>
      </div>
    </main>

  </div>

  <!-- ─── Trade Modal ─── -->
  <div class="modal-overlay" id="tradeModal">
    <div class="modal">
      <div class="modal-header">
        <div class="modal-title" id="tradeModalTitle">交易</div>
        <button class="modal-close" onclick="closeModal('tradeModal')">✕</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <div class="input-group">
          <label class="input-label">股票代码</label>
          <input class="input" id="tradeSymbol" placeholder="AAPL" />
        </div>
        <div class="input-group">
          <label class="input-label">数量 (股)</label>
          <input class="input" id="tradeQty" type="number" min="0.0001" step="1" value="1" placeholder="1" />
        </div>
        <div class="input-group">
          <label class="input-label">价格 (留空使用市价)</label>
          <input class="input" id="tradePrice" type="number" step="0.01" placeholder="市价" />
        </div>
        <div id="tradeCostPreview"
          style="font-size:13px;color:var(--text-muted);padding:10px;background:var(--bg-secondary);border-radius:8px;">
        </div>
        <div style="display:flex;gap:8px;">
          <button class="btn btn-success w-full" id="tradeBuyBtn" onclick="submitTrade('BUY')">✅ 买入</button>
          <button class="btn btn-danger w-full" id="tradeSellBtn" onclick="submitTrade('SELL')">🔴 卖出</button>
        </div>
      </div>
    </div>
  </div>

  <!-- ─── Recharge Modal ─── -->
  <div class="modal-overlay" id="rechargeModal">
    <div class="modal" style="max-width:350px;">
      <div class="modal-header">
        <div class="modal-title">💰 账户充值 (模拟)</div>
        <button class="modal-close" onclick="closeModal('rechargeModal')">✕</button>
      </div>
      <div style="display:flex;flex-direction:column;gap:16px;">
        <p style="font-size:13px;color:var(--text-secondary);">增加您的模拟交易资金。此操作仅影响模拟账户，不涉及真实资金。</p>
        <div class="input-group">
          <label class="input-label">存入金额 (USD)</label>
          <input class="input" id="quickDepositAmount" type="number" min="1" placeholder="例如: 10000" value="10000" />
        </div>
        <button class="btn btn-success w-full" style="padding:12px;" onclick="handleQuickRecharge()">确认充值</button>
      </div>
    </div>
  </div>

  <script src="/static/app.js?v=4"></script>
</body>

</html>